<app-header></app-header>

<div class="page-center">
  <div class="card stack-lg">
    <header>
      <div>
        <h2>Mis Mascotas</h2>
        <div class="muted">Gestiona tus mascotas para reservar más rápido</div>
      </div>
      <button class="btn" style="width:auto;padding:10px 14px" (click)="toggleForm()">
        {{ showForm ? 'Cerrar' : 'Agregar' }}
      </button>
    </header>

    <div class="error" *ngIf="error">{{ error }}</div>
    <app-loader *ngIf="loading" label="Cargando mascotas"></app-loader>

    <!-- Add / Edit Sheet -->
    <section class="sheet" *ngIf="showForm">
      <div class="sheet-header">
        <h3>Nueva mascota</h3>
        <p class="muted">Completa los datos básicos y de salud</p>
      </div>
      <div class="stack">
        <label class="label">Nombre</label>
        <input
          #nameInput
          class="input"
          [class.invalid]="submittedAdd && nameInvalid"
          [(ngModel)]="model.name"
          (ngModelChange)="persistDraft()"
          placeholder="Nombre de la mascota"
          maxlength="40"
        />
        <div class="error" *ngIf="submittedAdd && nameInvalid">
          El nombre es obligatorio y debe tener entre 2 y 40 caracteres.
        </div>

        <label class="label">Raza</label>
        <input
          class="input"
          [(ngModel)]="model.breed"
          (ngModelChange)="persistDraft()"
          placeholder="Raza"
          maxlength="60"
        />

        <label class="label">Sexo</label>
        <select class="input" [(ngModel)]="model.sex" (ngModelChange)="persistDraft()">
          <option value="M">Macho</option>
          <option value="F">Hembra</option>
        </select>

        <div class="grid-2">
          <div>
            <label class="label">Edad (años)</label>
            <input
              #ageInput
              class="input"
              type="number"
              min="0"
              max="30"
              [class.invalid]="submittedAdd && ageInvalid"
              [(ngModel)]="model.age"
              (ngModelChange)="persistDraft()"
              placeholder="Edad en años (0 a 30)"
            />
            <div class="error" *ngIf="submittedAdd && ageInvalid">
              La edad debe estar entre 0 y 30 años.
            </div>
          </div>
          <div>
            <label class="label">Peso (kg)</label>
            <input
              #weightInput
              class="input"
              type="number"
              step="0.1"
              min="0"
              max="100"
              [class.invalid]="submittedAdd && weightInvalid"
              [(ngModel)]="model.weight"
              (ngModelChange)="persistDraft()"
              placeholder="Peso aproximado (0 a 100 kg)"
            />
            <div class="error" *ngIf="submittedAdd && weightInvalid">
              El peso debe estar entre 0 y 100 kg.
            </div>
          </div>
        </div>

        <label class="label">Comportamiento</label>
        <input
          class="input"
          [(ngModel)]="model.behavior"
          (ngModelChange)="persistDraft()"
          placeholder="Tranquilo, nervioso, juguetón..."
          maxlength="120"
        />

        <label class="label">Salud y cuidados especiales</label>
        <textarea
          class="input"
          [(ngModel)]="model.healthNotes"
          (ngModelChange)="persistDraft()"
          placeholder="Alergias, condiciones médicas, vacunas, desparasitaciones"
          maxlength="400"
        ></textarea>

        <label class="label">Vacunas</label>
        <textarea
          class="input"
          [(ngModel)]="model.vaccinations"
          (ngModelChange)="persistDraft()"
          placeholder="Ej: Rabia (2025-01-10), Polivalente (2024-08-12)"
          maxlength="300"
        ></textarea>

        <label class="label">Desparasitación</label>
        <textarea
          class="input"
          [(ngModel)]="model.deworming"
          (ngModelChange)="persistDraft()"
          placeholder="Ej: Interna (2024-11-01), Externa (2024-09-15)"
          maxlength="300"
        ></textarea>

        <label class="label">Condiciones médicas</label>
        <textarea
          class="input"
          [(ngModel)]="model.medicalConditions"
          (ngModelChange)="persistDraft()"
          placeholder="Ej: alergia a pulgas, piel sensible"
          maxlength="300"
        ></textarea>

        <label class="label">Último servicio de peluquería</label>
        <input
          class="input"
          type="date"
          [(ngModel)]="model.lastGroomDate"
          (ngModelChange)="persistDraft()"
        />

        <button class="btn" (click)="add()">Añadir mascota</button>
      </div>
    </section>

    <!-- Pets Grid -->
    <section *ngIf="items.length; else emptyState">
      <div class="pets-grid">
        <article class="pet-card" *ngFor="let p of items">
          <div class="pet-header">
            <div class="avatar" [attr.aria-label]="p.name">
              <span>{{ (p.name || '?').slice(0,1).toUpperCase() }}</span>
            </div>
            <div class="title">
              <h3>{{ p.name }}</h3>
              <p class="muted">{{ p.breed || 'Sin raza' }}</p>
            </div>
            <div class="actions">
              <button class="icon-btn" (click)="toggleExpand(p.id)">
                <svg
                  [class.rotate]="isExpanded(p.id)"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ><polyline points="6 9 12 15 18 9"></polyline></svg>
              </button>
              <button class="icon-btn danger" (click)="openDelete(p)">
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                ><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </div>
          </div>

          <div class="chips">
            <span class="chip">{{ p.sex === 'F' ? 'Hembra' : 'Macho' }}</span>
            <span class="chip" *ngIf="p.age !== undefined">{{ p.age }} años</span>
            <span class="chip" *ngIf="p.weight !== undefined">{{ p.weight }} kg</span>
          </div>

          <div class="sections" [class.open]="isExpanded(p.id)">
            <div class="section">
              <h4>Datos básicos</h4>
              <div class="kv"><span>Raza</span><b>{{ p.breed || '—' }}</b></div>
              <div class="kv"><span>Último servicio</span><b>{{ p.lastGroomDate || '—' }}</b></div>
            </div>
            <div class="section">
              <h4>Comportamiento</h4>
              <p>{{ p.behavior || 'Sin información' }}</p>
            </div>
            <div class="section">
              <h4>Salud</h4>
              <div class="kv"><span>Vacunas</span><b>{{ p.vaccinations || '—' }}</b></div>
              <div class="kv"><span>Desparasitación</span><b>{{ p.deworming || '—' }}</b></div>
              <div class="kv"><span>Condiciones médicas</span><b>{{ p.medicalConditions || '—' }}</b></div>
              <div class="kv"><span>Notas de salud</span><b>{{ p.healthNotes || '—' }}</b></div>
            </div>
          </div>
        </article>
      </div>
    </section>

    <ng-template #emptyState>
      <app-empty-state
        title="Sin mascotas"
        description="Agrega tu primera mascota para agilizar tus reservas."
      >
      </app-empty-state>
    </ng-template>

    <app-modal
      [open]="confirmOpen"
      title="Eliminar mascota"
      [message]="'¿Eliminar ' + (pendingDelete?.name || 'esta mascota') + '?'"
      confirmLabel="Eliminar"
      cancelLabel="Cancelar"
      (confirm)="confirmDelete()"
      (cancel)="cancelDelete()"
    ></app-modal>
  </div>
</div>

