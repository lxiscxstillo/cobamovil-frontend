<app-header></app-header>

<div class="page-center">
  <div class="card stack-lg" style="max-width:980px;">
    <header>
      <div>
        <h2>Mis reservas</h2>
        <div class="muted">Consulta y gestiona tus servicios programados</div>
      </div>
    </header>

    <div class="loading" *ngIf="loading">Cargando tus reservas próximas…</div>
    <div class="error" *ngIf="error">{{ error }}</div>

    <div class="reservas-grid" *ngIf="!loading && !error && items.length">
      <article class="reserva" *ngFor="let b of items">
        <div class="top">
          <div>
            <h3>{{ b.petName }}</h3>
            <p class="muted">{{ b.serviceType }} · {{ b.date }} · {{ b.time }}</p>
          </div>
          <div class="status" [attr.data-status]="b.status">
            {{ b.status }}
            <span *ngIf="b.status === 'PENDING'" class="status-note"> · Pendiente de aprobación</span>
          </div>
        </div>

        <div class="actions">
          <a class="link" [href]="mapsUrl(b)" target="_blank" rel="noopener">Ver en mapa</a>
          <button
            class="btn secondary"
            style="width:auto;padding:8px 12px"
            *ngIf="canModify(b)"
            (click)="toggleEdit(b.id)"
          >
            {{ isEditing(b.id) ? 'Cerrar' : 'Reprogramar' }}
          </button>
          <button
            class="btn danger"
            style="width:auto;padding:8px 12px"
            *ngIf="canModify(b)"
            (click)="doCancel(b)"
          >
            Cancelar
          </button>
          <button class="icon" (click)="toggleExpand(b.id)" aria-label="Detalles">
            <svg [class.rotate]="isExpanded(b.id)" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </button>
        </div>

        <p class="muted" *ngIf="canModify(b)">
          La cita todavía no ha sido aceptada. Puedes cancelarla o reprogramarla sin problema.
        </p>
        <p class="muted" *ngIf="!canModify(b)">
          Esta cita ya fue aceptada por el peluquero, por lo tanto ya no puede ser modificada.
        </p>

        <div class="details" [class.open]="isExpanded(b.id)">
          <div class="kv"><span>Dirección</span><b>{{ b.address || '—' }}</b></div>
          <div class="kv" *ngIf="b.notes"><span>Notas</span><b>{{ b.notes }}</b></div>
        </div>

        <div class="edit" *ngIf="isEditing(b.id)">
          <div class="grid-2">
            <div>
              <label class="label">Nueva fecha</label>
              <input class="input" type="date" [(ngModel)]="reschedule[b.id].date" />
            </div>
            <div>
              <label class="label">Nueva hora</label>
              <input class="input" type="time" step="1800" [(ngModel)]="reschedule[b.id].time" />
            </div>
          </div>
          <div class="error" *ngIf="rescheduleError[b.id]">{{ rescheduleError[b.id] }}</div>
          <div class="edit-actions">
            <button class="btn" style="width:auto;padding:10px 14px" (click)="doReschedule(b)">Guardar cambios</button>
          </div>
        </div>
      </article>
    </div>

    <div class="empty" *ngIf="!loading && !error && !items.length">
      <p class="empty-title">No tienes reservas próximas</p>
      <p class="empty-text">Cuando agendes una cita futura, la verás aquí para consultarla, reprogramarla o cancelarla.</p>
      <a routerLink="/reservar" class="btn">Agendar nueva reserva</a>
    </div>
  </div>
</div>
